import { Module, Plugin } from 'boost';

declare module '@beemo/core' {
  import type { Event, EventListener, Tool, Reporter } from 'boost';
  import typeof Yargs from 'yargs';

  declare export type DriverContext = {
    args: string[],
    argsObject: Object,
    configPaths: string[],
    configRoot: string,
    drivers: Driver[],
    primaryDriver: Driver,
    root: string,
  };

  declare export type ScriptContext = {
    args: string[],
    configRoot: string,
    root: string,
    script: ?Script,
    scriptName: string,
    scriptPath: string,
  };

  declare export type Execution = {
    cmd: string,
    code: string | number,
    failed: boolean,
    killed?: boolean,
    signal: ?number,
    stderr: string,
    stdout: string,
    timedOut: boolean,
  };

  declare export type DriverMetadata = {
    bin: string,
    configName: string,
    configOption: string,
    dependencies: string[],
    description: string,
    helpOption: string,
    title: string,
    useConfigOption: boolean,
  };

  declare export type DriverOptions = {
    args: string[],
    dependencies: string[],
    env: { [key: string]: string },
  };

  declare export class Script<To: Object> extends Module<To> {
    run(options: Object, tool: Tool<Driver, Reporter<Object>>): Promise<*>;
    setup(): Object;
  }

  declare export class Driver extends Plugin<DriverOptions> {
    metadata: DriverMetadata;
    options: DriverOptions;

    constructor(options?: Object): this;
    bootstrapCommand(command: Yargs): void;
    formatFile(data: Object): string;
    handleFailure(error: Execution): void;
    handleSuccess(response: Execution): void;
    mergeConfig(prev: Object, next: Object): Object;
    on(eventName: string, listener: EventListener): this;
    setMetadata(metadata: Object): this;
  }

  declare export default class Beemo {
    context: Context;
    tool: Tool<Driver, Reporter<Object>>;

    constructor(argv: string[]): this;
    cleanUpOnFailure(event: Event, code: number): void;
    getConfigModuleRoot(): string;
    executeDriver(driverName: string): Promise<*>;
    executeScript(scriptName: string): Promise<*>;
    syncDotfiles(): Promise<*>;
  }
}
